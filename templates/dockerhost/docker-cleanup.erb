#!/bin/bash
# Cleanup docker files: untagged containers and images.
#
# Use `docker-cleanup -n` for a dry run to see what would be deleted.

untagged_containers() {
	# Print containers using untagged images: $1 is used with awk's print: 0=line, 1=column 1.
	# NOTE: "[0-9a-f]{12}" does not work with GNU Awk 3.1.7 (RHEL6).
	#       Ref: https://github.com/blueyed/dotfiles/commit/a14f0b4b#commitcomment-6736470
	docker ps -a | tail -n +2 | awk '$2 ~ "^[0-9a-f]+$" {print $'$1'}'
}

untagged_images() {
	# Print untagged images: $1 is used with awk's print: 0=line, 3=column 3.
	# NOTE: intermediate images (via -a) seem to only cause
	# "Error: Conflict, foobarid wasn't deleted" messages.
	# Might be useful sometimes when Docker messed things up?!
	# docker images -a | awk '$1 == "<none>" {print $'$1'}'
	docker images | tail -n +2 | awk '$2 == "<none>" {print $'$1'}'
}

# force?
force=""
if [[ "$1" == "-f" ]]; then
        force="-f"
        shift
# Dry-run.
elif [[ "$1" == "-n" ]]; then
	echo "=== Containers with untagged images: ==="
	untagged_containers 0
	echo

	echo "=== Untagged images: ==="
	untagged_images 0

	exit
fi
if [[ -n "$1" ]]; then
	echo "Cleanup docker files: remove untagged containers and images."
	echo "Usage: ${0##*/} [-f|-n]"
	echo "   -n: dry run: display what would get removed."
        echo "   -f: force - DANGER Will Robinson!"
	exit 1
fi

echo "Removing stopped containers with untagged images:" >&2
untagged_container_list="$(untagged_containers 1)"
for untagged_container in $untagged_container_list
do
    if [[ $(docker inspect --format '{{.State.Running}}' ${untagged_container}) == "false" ]]; then
        echo "${untagged_container}" | xargs --no-run-if-empty docker rm --volumes=true $force
    fi
done

echo "Removing untagged images that are not in use by running containers:" >&2
untagged_images_list="$(untagged_images 3)"
for untagged_image in $untagged_images_list
do
    if [[ "$(docker ps --format "{{.Image}}")" =~ ${untagged_image} ]]; then
        echo "Not removing ${untagged_image} that is in use by a running container"
    else
        echo "${untagged_image}" | xargs --no-run-if-empty docker rmi $force
    fi
done
