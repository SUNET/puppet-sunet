#!/usr/bin/env bash

set -e

bootstrap=0
if [ ! -d /etc/letsencrypt/live ]; then
	bootstrap=1
fi

if [ "${bootstrap}" == 1 ]; then
	targetdir=/etc/letsencrypt/
else
	targetdir=$(mktemp -d /tmp/certbot_sync.XXXXX)
fi

rsync -e "ssh -i $HOME/.ssh/id_certbot_sync_client" -az -v root@<%= scope.call_function('safe_hiera', ['certbot_sync_server'])  %>: "${targetdir}"

certs_to_deploy=()
if [ "${bootstrap}" == 1 ]; then
	for file_system_entity in "${targetdir}"/live/*; do
		basename=$(basename "${file_system_entity}")
		if [ "$basename" == "README" ]; then
			continue
		else
			certs_to_deploy+=("${basename}")
		fi
	done
else
	for file_system_entity in "${targetdir}"/live/*; do
		basename=$(basename "${file_system_entity}")
		if [ "$basename" == "README" ]; then
			continue
		else
			if [ ! -d "/etc/letsencrypt/live/${basename}" ]; then
				certs_to_deploy+=("${basename}")
				continue
			fi
		fi
		if ! cmp -s "/etc/letsencrypt/live/${basename}/fullchain.pem" "${targetdir}/live/${basename}/fullchain.pem"; then
			certs_to_deploy+=("${basename}")
		fi

	done
fi

if [ "${bootstrap}" == 0 ]; then
	rsync -av --delete "${targetdir}/" /etc/letsencrypt/
	rm -rf "${targetdir}"
fi

for cert in "${certs_to_deploy[@]}"; do
	echo "Running deploy hook(s) for ${cert}."
	for hook in /etc/letsencrypt/renewal-hooks/deploy/*; do
		RENEWED_LINEAGE="/etc/letsencrypt/live/${cert}" "${hook}"
	done
done
