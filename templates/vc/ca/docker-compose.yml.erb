---
version: "3.3"

services:
  ca:
    image: "docker.sunet.se/dc4eu/pkcs11_ca:<%= @ca_version %>"
    ports:
      - "8005:8005"
    depends_on:
      - "postgres"
    restart: always
    read_only: true
    cap_drop: [ALL]
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./data/hsm_tokens:/var/lib/softhsm/tokens
    tmpfs:
      - /dev/shm:ro,noexec,nosuid,nodev
    environment:
      - CA_URL=<%= @ca_url %>
      - ACME_ROOT=<%= @acme_root %>
      - PKCS11_SIGN_API_TOKEN=<%= @pkcs11_sign_api_token %>
      - PKCS11_TOKEN=<%= @pkcs11_token %>
      - PKCS11_PIN=<%= @pkcs11_pin %>
      - PKCS11_MODULE=<%= @pkcs11_module %>
      - POSTGRES_HOST=<%= @postgres_host %>
      - POSTGRES_USER=<%= @postgres_user %>
      - POSTGRES_PASSWORD=<%= @postgres_password %>
      - POSTGRES_PORT=<%= @postgres_port %>
      - POSTGRES_DATABASE=<%= @postgres_database %>
      - POSTGRES_TIMEOUT=<%= @postgres_timeout %>
    networks:
      - ca-net

  postgres:
    image: <%= @postgres_image %>:<%= @postgres_version %>
    restart: always
    volumes:
      - ./data/db_data:/var/lib/postgresql/data
    tmpfs:
      - /dev/shm:ro,noexec,nosuid,nodev
    environment:
      - POSTGRES_DB=<%= @postgres_database %>
      - POSTGRES_USER=<%= @postgres_user %>
      - POSTGRES_PASSWORD=<%= @postgres_password %>
    networks:
      - ca-net

  pdfsign:
    image: "docker.sunet.se/dc4eu/pkcs11_pdfsign:<%= @ca_version %>"
    ports:
      - "8006:8006"
    depends_on:
      - "ca"
    restart: always
    cap_drop: [ALL]
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /dev/shm:ro,noexec,nosuid,nodev
    environment:
      - CA_URL=<%= @ca_url %>
    networks:
      - ca-net

  networks:
    ca-net:
      driver: bridge
      driver_opts:
        com.docker.network.bridge.name: br-ca
    ipam:
      driver: default
      config:
        - subnet: 172.16.51.0/24