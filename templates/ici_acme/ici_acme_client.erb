#!/bin/bash

set -e

DEHYDRATED_CONFIG=/etc/ici_acme/dehydrated/config

source ${DEHYDRATED_CONFIG}

BASEDIR=$(dirname ${DEHYDRATED_CONFIG})

if [[ ! ${ACCOUNTDIR} ]]; then
    ACCOUNTDIR="${BASEDIR}/accounts"
fi

if [[ ! -f ${ACCOUNTDIR}/*/registration_info.json ]]; then #|| ! grep -q ${CA} ${ACCOUNTDIR}/*/registration_info.json ]]; then
    /usr/local/sbin/dehydrated --config ${DEHYDRATED_CONFIG} --register --accept-terms
fi

FQDN=$(hostname -f)
if [[ -f ${BASEDIR}/certs/${FQDN}/cert.pem ]]; then
    /usr/local/sbin/ici-acme-pre-auth.py --url ${CA} \
					 --dehydrated_account_dir ${ACCOUNTDIR}/* \
					 renew \
					 --cert dehydrated_client/certs/${FQDN}/cert.pem \
					 --key dehydrated_client/certs/${FQDN}/privkey.pem
else
    if [[ -f ${BASEDIR}/preauth_token.yaml ]]; then
	/usr/local/sbin/ici-acme-pre-auth.py --debug --url ${CA} \
					     --dehydrated_account_dir ${ACCOUNTDIR}/* \
					     init \
					     --token_file ${BASEDIR}/preauth_token.yaml
    else
	echo "$0: No existing certificate (${BASEDIR}/certs/${FQDN}/cert.pem), and ${BASEDIR}/preauth_token.yaml not found"
	exit 1
    fi
fi

dehydrated --cron -a prime256v1 --force --config ${DEHYDRATED_CONFIG} --domain ${FQDN}

rm -f ${BASEDIR}/preauth_token.yaml

echo "$0: All done"
exit 0
