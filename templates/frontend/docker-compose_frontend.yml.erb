---
version: '3.6'
services:


  api:
    image: "<%= scope['sunet::frontend::load_balancer::services::api_image'] -%>:<%= scope['sunet::frontend::load_balancer::services::api_imagetag'] -%>"
    restart: always
    volumes:
      - "<%= scope['sunet::frontend::load_balancer::services::api_basedir'] -%>/backends:/backends"
    ports:
      - "<%= scope['sunet::frontend::load_balancer::services::api_port'] -%>:8080"
    user: "<%= scope['sunet::frontend::load_balancer::users::user2uid']['fe-api'] -%>:<%= scope['sunet::frontend::load_balancer::users::user2uid']['fe-api'] -%>"
    environment:
      - "runas_user=fe-api"
      - "runas_group=fe-api"

  telegraf:
    image: "<%= scope['sunet::frontend::load_balancer::services::telegraf_image'] -%>:<%= scope['sunet::frontend::load_balancer::services::telegraf_imagetag'] -%>"
    restart: always
    volumes:
      - "<%= scope['sunet::frontend::load_balancer::services::telegraf_basedir'] -%>/telegraf.conf:/etc/telegraf/telegraf.conf:ro"
<% scope['sunet::frontend::load_balancer::services::telegraf_volumes'].each do | this | -%>
      - <%= this %>
<% end -%>
    ports:
      - "<%= scope['sunet::frontend::load_balancer::services::statsd_port'] -%>:8125/udp"
    user: "<%= scope['sunet::frontend::load_balancer::users::user2uid']['telegraf'] -%>:<%= scope['sunet::frontend::load_balancer::users::user2uid']['telegraf'] -%>"



networks:
  default:
    driver_opts:
      com.docker.network.bridge.name: br-frontend
