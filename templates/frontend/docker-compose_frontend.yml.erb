---
version: '3.6'
services:


  api:
    image: "<%= scope['sunet::frontend::load_balancer::services::api_image'] -%>:<%= scope['sunet::frontend::load_balancer::services::api_imagetag'] -%>"
    restart: always
    volumes:
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - "<%= scope['sunet::frontend::load_balancer::services::basedir'] -%>/backends:/backends"
    ports:
      - "<%= scope['sunet::frontend::load_balancer::services::api_port'] -%>:8080"

  exabgp:
    image: "<%= scope['sunet::frontend::load_balancer::services::exabgp_image'] -%>:<%= scope['sunet::frontend::load_balancer::services::exabgp_imagetag'] -%>"
    restart: always
    command:
      - /etc/bgp/exabgp.conf
    networks:
      fake_host_net:
        ipv4_address: 130.242.131.3
        ipv6_address: 2001:6b0:54:c4::3
    volumes:
      - /etc/bgp:/etc/bgp:ro
<% scope['sunet::frontend::load_balancer::services::exabgp_volumes'].each do | this | -%>
      - <%= this %>
<% end -%>

  telegraf:
    image: "<%= scope['sunet::frontend::load_balancer::services::telegraf_image'] -%>:<%= scope['sunet::frontend::load_balancer::services::telegraf_imagetag'] -%>"
    restart: always
    volumes:
      - "<%= scope['sunet::frontend::load_balancer::services::telegraf_basedir'] -%>/telegraf.conf:/etc/telegraf/telegraf.conf:ro"
<% scope['sunet::frontend::load_balancer::services::telegraf_volumes'].each do | this | -%>
      - <%= this %>
<% end -%>



networks:
  default:
    driver_opts:
      com.docker.network.bridge.name: br-frontend

  fake_host_net:
    ipam:
      driver: default
      config:
        - subnet: "130.242.131.0/28"
        - subnet: "2001:6b0:54:c4::/64"
