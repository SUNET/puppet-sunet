---
version: '3.5'
services:
  api:
    image: <%= @docker_image %>:<%= @docker_tag %>
    expose:
      - "8000"
    dns:
      - 89.32.32.32
    depends_on:
      - postgres
    volumes:
      - /opt/argus_config/localsettings.py:/opt/venv/lib/python3.13/site-packages/argus/site/settings/localsettings.py
    environment:
      - TIME_ZONE=Europe/Oslo
      - DJANGO_SETTINGS_MODULE=argus.site.settings.localsettings
      - DATABASE_URL=postgresql://argus:<%= scope.call_function('safe_hiera',['argus_db_password']) %>@postgres/argus
      - ARGUS_FRONTEND_URL=https://<%= @url%>
      - EMAIL_HOST=<%= scope.call_function('safe_hiera',['argus_email_host']) %>
      - EMAIL_HOST_USER=<%= scope.call_function('safe_hiera',['argus_email_user']) %>
      - EMAIL_HOST_PASSWORD=<%= scope.call_function('safe_hiera',['argus_email_password']) %>
      - ARGUS_SEND_NOTIFICATIONS=1
      - DEFAULT_FROM_EMAIL=<%= scope.call_function('safe_hiera',['argus_email_from']) %>
      - SMS_GATEWAY_ADDRESS=<%= scope.call_function('safe_hiera',['argus_sms_gateway']) %>
      - DEFAULT_SMS_MEDIA="argus.notificationprofile.media.sms_as_email.SMSNotification"
      - EMAIL_BACKEND="django.core.mail.backends.smtp.EmailBackend"Â´
      - SECRET_KEY=<%= scope.call_function('safe_hiera',['django_secret_key']) %>
    restart: always

  postgres:
    image: "postgres:18.1"
    volumes:
      - postgres:/var/lib/postgresql:Z
    restart: always
    environment:
      - POSTGRES_USER=argus
      - POSTGRES_PASSWORD=<%= scope.call_function('safe_hiera',['argus_db_password']) %>
      - POSTGRES_DB=argus

  nginx_argus:
    container_name: nginx_argus
    image: "nginx:1.29"
    depends_on:
      - postgres
      - api
    volumes:
      - /opt/nginx_etc/conf.d:/etc/nginx/conf.d
      - /etc/letsencrypt:/etc/letsencrypt
    ports:
      - "443:443"

volumes:
  postgres:
    driver: local
