version: '3.2'

services:
  app:
    image: docker.sunet.se/bankid-idp:<%= @imagetag %>
<% unless @resolvers.empty? -%>
    dns:
<% @resolvers.each do |resolver| -%>
      - <%= resolver %>
<% end -%>
<% end -%>
    environment:
      - TZ=<%= @tz %>
      - SPRING_PROFILES_ACTIVE=<%= @spring_profiles_active %>
      - SERVER_SERVLET_CONTEXT_PATH=<%= @server_servlet_context_path %>
      - SAML_IDP_BASE_URL=<%= @saml_idp_base_url %>
      - SPRING_CONFIG_IMPORT=<%= @bankid_home %><%= @spring_config_import %>
<% @environments_extras.each do |environment| -%>
      - <%= environment %>
<% end -%>
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/opt/bankid:<%= @bankid_home %>"
<%- @volumes_extras.each do |extra_volume| -%>
      - "<%= extra_volume %>"
<%- end -%>
<% unless @ports_extras.empty? -%>
    ports:
      - "8012:8012"
      - "8082:8082"
<%- @ports_extras.each do |port| -%>
      - "<%= port %>"
<%- end -%>

  redis:
    image: redis:7-bullseye
    volumes:
      - /opt/redis/:/data
    command: redis-server /data/server.conf
    ports:
      - "6379:6379"
    restart: always
<% end -%>
