#!/bin/bash

set -e

reinst="/mnt/seed/sunet-reinstall.tgz"

test -d /mnt/seed || mkdir /mnt/seed
vdb_fail=0
mount /dev/vdb /mnt/seed || vdb_fail=1

if [ $vdb_fail -ne 0 ]; then
    rmdir /mnt/seed
    reinst="/root/`hostname -f`_sunet-reinstall.tgz"
    echo "$0: mounting /dev/vdb failed, output to local file ${reinst} instead?"
    echo "Note that you will have to take care of the file yourself."
    echo ""
    echo "Press Ctrl+C to abort, or enter to continue"
    read foo
else
    trap "umount /mnt/seed && rmdir /mnt/seed" EXIT
fi

if [ -f ${reinst} ]; then
   echo "$0: File sunet-reinstall.tgz already exist:"
   echo ""
   ls -l ${reinst}
   echo ""
   tar tzvf ${reinst} || true
   echo ""
   echo "Press enter to overwrite it, or CTRL+C to abort"
   read foo
fi

umask 077

(test -f /etc/sunet-reinstall.keep && cat /etc/sunet-reinstall.keep;
 test -f /etc/sunet-reinstall.keep && echo /etc/sunet-reinstall.keep;
      echo /etc/ssh/*key*;
      test -d /etc/hiera/gpg && echo /etc/hiera/gpg;
      test -d /etc/letsencrypt && echo /etc/letsencrypt;
) | xargs tar zcvf ${reinst}

echo ""
echo "$0: Done"
echo ""
