#!/bin/bash
#
# Script to (re-)create a cloud-image based VM. Created by puppet-sunet - do not edit.
#

set -e

src_image="<%= @image_src %>"
size="<%= @size %>"
mac="<%= @mac %>"
hostname="<%= @name %>"
bridge="<%= @bridge %>"
cpus="<%= @cpus %>"
mem="<%= @memory %>"
description="<%= @description %>"
apt_dir="<%= @apt_dir %>"

cd "/var/lib/libvirt/images/"

id=$(uuidgen)

seed=${hostname}_seed.img
disk=${hostname}.img

if [ ! -f ${seed} ]; then
    # If the seed file exists, just update it with new user-data and meta-data below
    # to facilitate reinstalls with 'sunet-reinstall'
    truncate --size 2M ${seed}
    mkfs.vfat -n cidata ${seed} 2>/dev/null
fi

chmod 600 ${seed}

for this in meta-data user-data network-config; do
    src="`dirname $0`/${hostname}_${this}"
    mcopy -o -i ${seed} ${src} ::${this} 2>/dev/null
done
mcopy -o -i ${seed} ${apt_dir}/bootstrap-cosmos.sh ${apt_dir}/cosmos_1.2-2_all.deb ::
reinst="`dirname $0`/${hostname}_sunet-reinstall.tar.gz"
if [ -f ${reinst} ]; then
    # one-time init a cloud-image from a host that presumably wasn't a cloud image VM before
    mcopy -o -i ${seed} ${reinst} ::
    shred -u ${reints} || rm -f ${reinst}
fi

virsh pool-refresh default

if [ ! -f /var/lib/libvirt/images/${disk} ]; then
    test -f /var/lib/libvirt/images/${disk} || virsh vol-clone --pool default ${src_image} ${disk}
    virsh vol-resize --pool default ${disk} ${size}
fi

chmod 600 ${disk}

network="--network bridge=${bridge}"
install_options=""

# Optional settings
if [ "x${mac}" != "x" ]; then
   network="${network},mac=${mac}"
fi
if [ "x${description}" != "x" ]; then
   install_options="${install_options} --description '${description}'"
fi

# destroy and undefine the domain if there is one (to allow reinstallation by removing the primary disk file)
virsh destroy ${hostname} || true
virsh undefine ${hostname} || true

# use eval to expand the $install_options properly
eval virt-install -r ${mem} -n ${hostname} --vcpus=${cpus} --autostart --memballoon virtio --boot hd \
    --disk path=/var/lib/libvirt/images/${disk},format=qcow2,bus=virtio \
    --disk path=/var/lib/libvirt/images/${seed},bus=virtio \
    ${network} \
    ${install_options}
