#!/usr/bin/env bash
#
# This wrapper is a bit silly but it might be the best way to be SURE that one broken domain doesn't
# mess up ALL configured domains. It will also, through scriptherder, hopefully highlight problems
# with domains that are either misconfigured or have any other kind of issues.
#
# This is sadly dependent upon /etc/dehydrated/config2 to work. DOMAINS_TXT variable could not be set
# outside of the configfile and I didn't want to break backwards comp by fiddling with domains.txt.
#
# Scriptherder was not meant to be run dynamically, must cheat to create check/ini-files...

DOMAINFILE="/etc/dehydrated/domains.txt"
HOOKFILE="/etc/dehydrated/hook.sh"
CONFIGFILE="/etc/dehydrated/config"
SCRIPTHERDER="/usr/local/bin/scriptherder"
SCRIPTHERDER_OPTIONS="--mode wrap --syslog --name "
SCRIPTHERDER_TEMPLATE="/etc/dehydrated/scriptherder_template.ini"
DEHYDRATED="/usr/sbin/dehydrated"
DEHYDRATED_OPTIONS="--no-lock --hook ${HOOKFILE} --config ${CONFIGFILE} "
DEHYDRATED_VERB="--cron"

/bin/cat ${DOMAINFILE} | while read line
do
  SINGLEDOMAIN=$(mktmp)
  echo $line > ${SINGLEDOMAIN}
  CONFIG_SINGLEDOMAIN="/etc/dehydrated/config-singledomain"
  echo "DOMAINS_TXT=\"${SINGLEDOMAIN}\"" > ${CONFIG_SINGLEDOMAIN} 
  JOBNAME="dehydrated_`awk '{ print $1 }' ${SINGLEDOMAIN}`"
  ${SCRIPTHERDER} ${SCRIPTHERDER_OPTIONS} ${JOBNAME} -- ${DEHYDRATED} ${DEHYDRATED_VERB} ${DEHYDRATED_OPTIONS} && /usr/bin/le-ssl-compat.sh
  JOBFILE="/etc/scriptherder/check/${JOBNAME}.ini" 
  if [ ! -f "$JOBFILE" ]; then
    /bin/cp $SCRIPTHERDER_TEMPLATE /etc/scriptherder/check/${JOBNAME}.ini
  fi
  rm ${SINGLEDOMAIN}
  rm ${CONFIG_SINGLEDOMAIN}
done

<% if @cleanup %>
  JOBNAME="dehydrated_cleanup"
  JOBFILE="/etc/scriptherder/check/${JOBNAME}.ini" 
  if [ ! -f "$JOBFILE" ]; then
    /bin/cp $SCRIPTHERDER_TEMPLATE /etc/scriptherder/check/${JOBNAME}.ini
  fi
  DEHYDRATED_VERB="--cleanup"
  ${SCRIPTHERDER} ${SCRIPTHERDER_OPTIONS} ${JOBNAME} -- ${DEHYDRATED} ${DEHYDRATED_VERB} ${DEHYDRATED_OPTIONS} && /usr/bin/le-ssl-compat.sh
<% end %>

exit 0
