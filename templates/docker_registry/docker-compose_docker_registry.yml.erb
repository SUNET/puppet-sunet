---
version: '2.1'
services:
    registry:
        image: registry:<%= @registry_tag %>
        container_name: registry
        depends_on:
            - registry-auth
        expose:
            - 5000
        volumes:
            - /var/lib/registry:/var/lib/registry:rw

    registry-auth:
        image: docker.sunet.se/sunet/docker-registry-auth:stable
        container_name: registry-auth
        ports:
            - 443:443
        volumes:
            - /etc/dehydrated/certs/<%= @fqdn %>.key:/etc/ssl/private/<%= @registry_public_hostname %>.key:ro
            - /etc/dehydrated/certs/<%= @fqdn %>.crt:/etc/ssl/certs/<%= @registry_public_hostname %>.crt:ro
            - /etc/dehydrated/certs/<%= @fqdn %>-chain.crt:/etc/ssl/certs/<%= @registry_public_hostname %>-chain.crt:ro
            - /etc/ssl/certs/infra.crt:/etc/ssl/certs/<%= @registry_public_hostname %>-client-ca.crt:ro
        environment:
            SERVER_NAME: "<%= @registry_public_hostname %>"

    always-https:
        image: docker.sunet.se/always-https
        container_name: always-https
        ports:
            - 80:80
        environment:
            - "ACME_URL=http://acme-c.sunet.se"
