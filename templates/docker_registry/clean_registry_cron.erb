#!/bin/bash

# If cosmos is disabled we should avoid running
if [[ -f /etc/no-automatic-cosmos ]]; then
    exit 1
fi

# We don't want to run cosmos during the cleanup
# to avoid that e.g. apache starts again and clients
# starts pulling and pushing.
touch /etc/no-automatic-cosmos

# Stop the Apache container so that no new requests
# are made during the cleanup.
docker stop registry-auth
exit_status="${?}"

if [[ "${exit_status}" = "0" ]]; then
    # Start the actual cleanup
    /usr/local/bin/clean-registry/clean_registry.py /usr/local/bin/clean-registry/config_file.yaml
    exit_status="${?}"
fi

if [[ "${exit_status}" = "0" ]]; then
    # A sleep before we start again might be good
    sleep 10

    # Run the garbage collection after removing layers
    docker exec registry /bin/registry garbage-collect /etc/docker/registry/config.yml
    exit_status="${?}"
fi

# Start all the containers again.
systemctl restart sunet-docker-registry

# Enable cosmos again
rm /etc/no-automatic-cosmos

# Use the exit status from the commands we care about
exit "${exit_status}"
