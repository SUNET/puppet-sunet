upstream django_ca {
    server django-ca-app:8000;
}

server {
    server_name  <%= @server_fqdn %>;

    location /django_ca/issuer/ {
       try_files "" @django_ca;
    }
    location /django_ca/crl/ {
        try_files "" @django_ca;
    }
    location /django_ca/ocsp/ {
        try_files "" @django_ca;
    }

    location / {
         # Support for HAProxy's Health checks which defaults to OPTIONS
         # https://www.haproxy.com/documentation/haproxy-configuration-tutorials/reliability/health-checks/
         if ($request_method = OPTIONS ) {
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 200;
         }
    }
}

server {
    listen       [::]:443 ssl ipv6only=off;
    server_name  <%= @server_fqdn %>;

    ssl_certificate_key /etc/ssl/private/<%= @server_fqdn %>_infra.key;
    ssl_certificate     /etc/ssl/certs/<%= @server_fqdn %>_infra.crt;

    location /django_ca/acme/ {
        try_files "" @django_ca;
    }
    location /django_ca/api/ {
        try_files "" @django_ca;
    }
    location /django_ca/issuer/ {
       try_files "" @django_ca;
    }
    location /django_ca/crl/ {
        try_files "" @django_ca;
    }
    location /django_ca/ocsp/ {
        try_files "" @django_ca;
    }
    location /admin/ {
        try_files "" @django_ca;
    }
    location /static/ {
        root   /usr/share/nginx/html/;
    }

    location / {
         # Support for HAProxy's Health checks which defaults to OPTIONS
         # https://www.haproxy.com/documentation/haproxy-configuration-tutorials/reliability/health-checks/
         if ($request_method = OPTIONS ) {
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 200;
         }
    }

    location @django_ca {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
        # we don't want nginx trying to do something clever with
        # redirects, we set the Host: header above already.
        proxy_redirect off;
        proxy_pass http://django_ca;
    }
}
