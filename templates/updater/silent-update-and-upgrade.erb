#!/bin/bash
#
# Script created by Puppet (sunet::updater)
#

export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'

if [[ "$1" == "--random-sleep" ]]; then
    sleep $(( $RANDOM % 120))
fi

status=1
apt-get -y update && env DEBIAN_FRONTEND='noninteractive' apt-get -y -o Dpkg::Options::='--force-confnew' upgrade && status=0
if [[ $status != 0 && "$1" == "--random-sleep" ]]; then
    echo ": apt failed, sleeping for 10 minutes before retrying"
    sleep 600
    apt-get -qq -y update && env DEBIAN_FRONTEND='noninteractive' apt-get -y -o Dpkg::Options::='--force-confnew' upgrade && status=0
fi

if [[ -f /var/run/reboot-required && -f /etc/cosmos-automatic-reboot ]]; then
    # Add a short sleep to allow someone logged in to abort the reboot
    sleep=15
    logger -p local0.emerg -i -t silent-update-and-upgrade "Rebooting automatically in ${sleep} seconds (if /var/run/reboot-required still exists)"
    sleep $sleep
    if [ -f /var/run/reboot-required ]; then
	logger -p local0.crit -i -t silent-update-and-upgrade "Rebooting automatically"
	reboot
    fi
fi

exit $status
