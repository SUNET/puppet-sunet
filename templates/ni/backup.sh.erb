#!/usr/bin/env bash

set -e

VIRTUALENV=/var/opt/norduni/norduni_environment
NORDUNIDIR=/var/opt/norduni/norduni
NISTORE=/var/opt/norduni/sunet-nistore

# Activate virtual environment
. $VIRTUALENV/bin/activate
# Pull the latest repo
/usr/local/bin/ni-pull.sh -r $NISTORE 
## Backup of SQL database
pg_dump norduni | gzip > $NISTORE/producers/noclook/sql/postgres.sql.gz
# Remove yesterdays Neo4j backup
find $NISTORE/producers/noclook/json/ -mindepth 1 -delete
# Backup Neo4j data
cd $NORDUNIDIR/src/scripts/
./noclook_producer.py -O $NISTORE/producers/noclook/json/
# Pull and push the repo
/usr/local/bin/ni-pull.sh -r $NISTORE 
/var/opt/norduni/norduni/src/scripts/git-scripts/ni-push.sh -r $NISTORE