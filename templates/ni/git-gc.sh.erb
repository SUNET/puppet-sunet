#!/bin/bash
#
# 2017-07-03
# mkr@nordu.net
#
# Generic git gc script that runs git gc, with optional stats.

GIT="/usr/bin/git"

usage="Usage: $0 [-h] [-s] -r <repository_location>"

STATS=0
while getopts ":r:s" options; do
  case $options in
    r ) REPO=$OPTARG;;
    s ) STATS=1;;
    h ) echo $usage;;
    \?) echo $usage
        exit 1;;
    * ) echo $usage
        exit 1;;
  esac
done

if [ -z $REPO ] || [ ! -d $REPO ]; then
  echo "Error: no repo @ $REPO, use -r <repository_location>"
  exit 1
fi

cd $REPO

if [ "$STATS" -eq "1" ]; then
  before=$(du -hs|cut -f1)
  time $GIT gc --quiet
else
  $GIT gc --quiet
fi


if [ "$STATS" -eq "1" ]; then
  echo "Before: $before"
  echo "After: $(du -hs|cut -f1)"
fi