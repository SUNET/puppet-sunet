###################################################
#
# This file is managed with
#
#  #####   #    #  #####   #####   ######   #####
#  #    #  #    #  #    #  #    #  #          #
#  #    #  #    #  #    #  #    #  #####      #
#  #####   #    #  #####   #####   #          #
#  #       #    #  #       #       #          #
#  #        ####   #       #       ######     #
#
# ... so you can't just change it locally.
#
###################################################

<% if @daemonize -%>
daemonize <%= @daemonize %>
<% else -%>
# daemonize not set in puppet
<% end -%>

<% if @sentinel_config == "yes" -%>
port 26379
<% else -%>
port 6379
<% end -%>

<% if @bind -%>
bind <%= @bind %>
<% else -%>
# bind not set in puppet
<% end -%>

dir /data

<% if @replica_node == "yes" -%>
replicaof <%= @master_ip %> <%= @public_port %>
<% if @public_ip -%>
replica-announce-ip <%= @public_ip %>
replica-announce-port <%= @public_port %>
<% end -%>
<% else -%>
# replica_node not set in puppet
<% end -%>

# Cluster config
<% if @cluster_config == "yes" -%>
cluster-enabled yes
cluster-config-file /data/cluster-config_do_not_edit_by_hand.data
cluster-node-timeout 5000
cluster-slave-validity-factor 0

<% if @public_ip -%>
cluster-announce-ip <%= @public_ip %>
cluster-announce-port <%= @public_port %>
cluster-announce-bus-port <%= @sentinel_port %>
<% end -%>
<% else -%>
# cluster_config not set in puppet
<% end -%>

# Sentinel config
<% if @sentinel_config == "yes" -%>

# monitor Docker container 'server' on port 6379
sentinel monitor <%= @cluster_name %> server 6379 2
sentinel down-after-milliseconds <%= @cluster_name %> 5000
sentinel parallel-syncs <%= @cluster_name %> 1
sentinel failover-timeout <%= @cluster_name %> 10000
sentinel announce-ip <%= @public_ip %>
sentinel announce-port <%= @sentinel_port %>
# make isolated master stop accepting writes
min-slaves-to-write 1
min-slaves-max-lag 10
<% else -%>
# sentinel_config not set in puppet
<% end -%>
